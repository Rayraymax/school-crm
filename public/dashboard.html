<!DOCTYPE html>
<html>
<head>
  <title>School CRM - Office Dashboard</title>
    <link rel="stylesheet" href="dashboard.css">
</head>
<body>
  <h1>Office Dashboard</h1>

<p>Logged in as: <span id="userRole"></span></p>
<button onclick="logout()">Logout</button>

  <!-- ðŸ”Ž Search & Filter Bar -->
  <div>
    <input type="text" id="searchName" placeholder="Search by School Name">
    <select id="filterInterest">
      <option value="">Filter by Interest Level</option>
      <option value="Interested">Interested</option>
      <option value="Needs Follow-up">Needs Follow-up</option>
      <option value="Contacted">Contacted</option>
      <option value="Meeting Scheduled">Meeting Scheduled</option>
      <option value="Closed">Closed</option>
      <option value="Pending">Pending</option>
      <option value="Not Interested">Not Interested</option>
    </select>
    <select id="filterAction">
      <option value="">Filter by Next Action</option>
      <option value="Call">Call</option>
      <option value="Email">Email</option>
      <option value="Meeting">Meeting</option>
      <option value="Demo">Demo</option>
      <option value="Other">Other</option>
    </select>
    <button onclick="applyFilters()">Apply Filters</button>
    <button onclick="resetFilters()">Reset</button>
    <button onclick="exportCSV()">Export to CSV</button>
  </div>

  <!-- ðŸ“ Add Lead Form -->
<div class="form-section" id="addLeadSection">
  <h3>Add New Lead</h3>
  <form id="addLeadForm">
    <!-- School Name -->
    <input type="text" id="school_name" placeholder="School Name" required>

    <!-- School Type -->
    <label>School Type:</label>
    <select id="school_type">
      <option value="">--Select--</option>
      <option value="Primary">Primary</option>
      <option value="Secondary">Secondary</option>
      <option value="Private">Private</option>
      <option value="Public">Public</option>
      <option value="Other">Other</option>
    </select>

    <!-- Location -->
    <input type="text" id="location" placeholder="Location">

    <!-- Contact Name -->
    <input type="text" id="contact_name" placeholder="Contact Name">

    <!-- Contact Role -->
    <label>Contact Role:</label>
    <select id="contact_role">
      <option value="">--Select--</option>
      <option value="Principal">Principal</option>
      <option value="Administrator">Administrator</option>
      <option value="ICT Coordinator">ICT Coordinator</option>
      <option value="Teacher">Teacher</option>
      <option value="Other">Other</option>
    </select>

    <!-- Phone -->
    <input type="tel" id="phone" placeholder="Phone">

    <!-- Email -->
    <input type="email" id="email" placeholder="Email">

    <!-- Visit Date -->
    <label>Date of Visit:</label>
    <input type="date" id="visit_date">

    <label>Upload Image:</label>
    <input type="file" id="lead_image" accept="image/*">

    <!-- Interest Level -->
    <label>Interest Level:</label>
    <select id="interest_level">
      <option value="">--Select--</option>
      <option value="Interested">Interested</option>
      <option value="Needs Follow-up">Needs Follow-up</option>
      <option value="Contacted">Contacted</option>
      <option value="Meeting Scheduled">Meeting Scheduled</option>
      <option value="Closed">Closed</option>
      <option value="Pending">Pending</option>
      <option value="Not Interested">Not Interested</option>
    </select>

    <!-- Notes -->
    <textarea id="notes" placeholder="Notes"></textarea>

    <!-- Next Action -->
    <label>Next Action:</label>
    <select id="next_action">
      <option value="">--Select--</option>
      <option value="Call">Call</option>
      <option value="Email">Email</option>
      <option value="Meeting">Meeting</option>
      <option value="Demo">Demo</option>
      <option value="Other">Other</option>
    </select>

    <!-- Follow-up Date -->
    <label>Follow-up Date:</label>
    <input type="date" id="follow_up_date">

    <!-- Buttons -->
    <button type="submit">Add Lead</button>
    <button type="button" id="deleteLeadBtn">Delete Lead</button>
  </form>
</div>

<!-- ðŸ“Š Leads Table -->
<table id="leadsTable">
  <thead>
    <tr>
      <th>School Name</th>
      <th>Type</th>
      <th>Location</th>
      <th>Contact Name</th>
      <th>Role</th>
      <th>Phone</th>
      <th>Email</th>
      <th>Visit Date</th>
      <th>Interest Level (Current)</th>
      <th>Notes</th>
      <th>Next Action</th>
      <th>Follow-up Date</th>
      <th>Update Status</th>
    </tr>
  </thead>
  <tbody>
    <!-- Rows will be loaded dynamically -->
  </tbody>
</table>

  <!-- ðŸ“„ Pagination Controls -->
  <div class="pagination" id="paginationControls"></div>

  <script>

document.addEventListener("DOMContentLoaded", function () {

  const API_BASE =
  window.location.hostname === "localhost"
    ? "http://localhost:5000"
    : "https://school-crm-sndl.onrender.com";
  const token = localStorage.getItem('jwtToken');
  let currentUserRole = "guest";
  let allLeads = [];
  let currentFiltered = [];
  let currentPage = 1;
  const rowsPerPage = 10;

  // ================= JWT =================
  function parseJwt(token) {
    try {
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
      return JSON.parse(jsonPayload);
    } catch (e) {
      return null;
    }
  }

  if (!token) {
    window.location.href = "login.html";
    return;
  }

  const decoded = parseJwt(token);
  if (decoded && decoded.role) {
    currentUserRole = decoded.role;
  }

  document.getElementById('userRole').textContent = currentUserRole;

  // ================= LOAD LEADS =================
  async function loadLeads() {
    try {
      const response = await fetch(`${API_BASE}/api/leads`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (!response.ok) throw new Error("Unauthorized");

      const data = await response.json();

      if (!Array.isArray(data)) {
        console.error("Leads not array:", data);
        return;
      }

      allLeads = data;
      currentFiltered = data;
      renderTable(data);

    } catch (err) {
      console.error(err);
      alert("Session expired. Please login again.");
      logout();
    }
  }

  function renderTable(leads) {
    const tbody = document.querySelector('#leadsTable tbody');
    tbody.innerHTML = '';

    const start = (currentPage - 1) * rowsPerPage;
    const paginated = leads.slice(start, start + rowsPerPage);

    paginated.forEach(lead => {
      const row = document.createElement('tr');

      row.innerHTML = `
        <td>${lead.school_name || ''}</td>
        <td>${lead.school_type || ''}</td>
        <td>${lead.location || ''}</td>
        <td>${lead.contact_name || ''}</td>
        <td>${lead.contact_role || ''}</td>
        <td>${lead.phone || ''}</td>
        <td>${lead.email || ''}</td>
        <td>${lead.visit_date || ''}</td>
        <td>${lead.interest_level || ''}</td>
        <td>${lead.notes || ''}</td>
        <td>${lead.next_action || ''}</td>
        <td>${lead.follow_up_date || ''}</td>
        <td>
          ${currentUserRole === 'manager'
            ? `<button onclick="deleteLead(${lead.id})">Delete</button>`
            : ''}
        </td>
      `;

      tbody.appendChild(row);
    });
  }

  // ================= EXPORT CSV =================
  window.exportCSV = function () {

    if (currentFiltered.length === 0) {
      alert("No data to export.");
      return;
    }

    let csv = "School Name,Type,Location,Contact Name,Role,Phone,Email,Visit Date,Interest Level,Notes,Next Action,Follow-up Date\n";

    currentFiltered.forEach(lead => {
      csv += `"${lead.school_name || ''}",
"${lead.school_type || ''}",
"${lead.location || ''}",
"${lead.contact_name || ''}",
"${lead.contact_role || ''}",
"${lead.phone || ''}",
"${lead.email || ''}",
"${lead.visit_date || ''}",
"${lead.interest_level || ''}",
"${lead.notes || ''}",
"${lead.next_action || ''}",
"${lead.follow_up_date || ''}"\n`;
    });

    const blob = new Blob([csv], { type: "text/csv" });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "leads.csv";
    a.click();
  };

  // ================= CREATE USER =================
  const addUserForm = document.getElementById('addUserForm');

  if (addUserForm) {
    addUserForm.addEventListener('submit', async function (e) {
      e.preventDefault();

      const username = document.getElementById('newUsername').value;
      const password = document.getElementById('newPassword').value;
      const role = document.getElementById('newRole').value;

      try {
        const response = await fetch(`${API_BASE}/api/users`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ username, password, role })
        });

        const result = await response.json();

        if (!response.ok) {
          alert(result.message || "Error creating user");
          return;
        }

        alert("User created successfully âœ…");
        addUserForm.reset();
        loadUsers();

      } catch (err) {
        console.error(err);
        alert("Server error while creating user.");
      }
    });
  }

  // ================= LOAD USERS =================
  async function loadUsers() {
    if (currentUserRole !== 'manager') {
      const section = document.getElementById('usersSection');
      if (section) section.style.display = 'none';
      return;
    }

    try {
      const response = await fetch(`${API_BASE}/api/users`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      const users = await response.json();
      const tbody = document.querySelector('#usersTable tbody');
      tbody.innerHTML = '';

      users.forEach(user => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${user.id}</td>
          <td>${user.username}</td>
          <td>${user.role}</td>
          <td><button onclick="deleteUser(${user.id})">Delete</button></td>
        `;
        tbody.appendChild(row);
      });

    } catch (err) {
      console.error(err);
    }
  }

  window.deleteUser = async function (id) {
    if (!confirm("Are you sure?")) return;

    await fetch(`${API_BASE}/api/users/${id}`, {
      method: 'DELETE',
      headers: { 'Authorization': `Bearer ${token}` }
    });

    loadUsers();
  };

  window.logout = function () {
    localStorage.removeItem('jwtToken');
    window.location.href = "login.html";
  };

  // INITIAL LOAD
  loadLeads();
  loadUsers();

});
</script>
  <div class="form-section" id="usersSection">
  <h3>User Management</h3>

  <form id="addUserForm">
    <input type="text" id="newUsername" placeholder="Username" required>
    <input type="password" id="newPassword" placeholder="Password" required>

    <select id="newRole">
      <option value="marketer">Marketer</option>
      <option value="staff">Staff</option>
      <option value="manager">Manager</option>
    </select>

    <button type="submit">Create User</button>
  </form>

  <table id="usersTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>Username</th>
        <th>Role</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>
</body>
<footer>
  <p>&copy; 2026 School CRM | Powered by Jendie Automobiles Ltd</p>
  <p>Contact: jendietrackmykid@gmail.com | +254 723 77 52 89</p>
</footer>
</html>
